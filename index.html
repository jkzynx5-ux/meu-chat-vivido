<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vivido Social</title>
    <style>
        :root {
            --gradient-me: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%);
            --gradient-bg: linear-gradient(180deg, #a1c4fd 0%, #c2e9fb 100%);
            --glass: rgba(255, 255, 255, 0.9);
            --accent: #00a884;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--gradient-bg); height: 100vh; display: flex; flex-direction: column; }

        /* TELAS */
        #login-container, #home-container, #chat-container { height: 100vh; width: 100%; display: none; flex-direction: column; }

        /* HOME / LISTA */
        .header-app { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .search-bar { padding: 15px; display: flex; gap: 8px; }
        .search-bar input { flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        .btn-round { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 20px; cursor: pointer; }

        /* CHAT GLASS */
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg-wrapper { display: flex; flex-direction: column; max-width: 80%; }
        .minha-msg { align-self: flex-end; }
        .minha-msg .msg-box { background: var(--gradient-me); color: white; border-radius: 18px 18px 0 18px; padding: 10px 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .outra-msg { align-self: flex-start; }
        .outra-msg .msg-box { background: var(--glass); color: #333; border-radius: 18px 18px 18px 0; padding: 10px 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .msg-box img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        .msg-time { font-size: 0.6rem; display: block; text-align: right; margin-top: 4px; opacity: 0.7; }

        /* FOOTER DARK */
        #footer { padding: 15px; }
        .input-area { background: #333; border-radius: 30px; padding: 5px 15px; display: flex; align-items: center; gap: 10px; }
        .input-area input { flex: 1; background: transparent; border: none; color: white; padding: 10px; outline: none; }

        /* REGISTRO */
        .login-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 350px; margin: auto; }
        .avatar-prev { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent); margin-bottom: 15px; object-fit: cover; }
    </style>
</head>
<body>

    <div id="login-container">
        <div class="login-box">
            <img id="reg-preview" class="avatar-prev" src="https://api.dicebear.com/7.x/avataaars/svg?seed=1">
            <input type="file" id="reg-file" accept="image/*" style="display:none" onchange="previewImg(event)">
            <button class="btn-round" onclick="document.getElementById('reg-file').click()" style="margin-bottom:15px">Escolher Foto</button>
            <input type="text" id="reg-nome" placeholder="Seu Nome" style="width:100%; padding:10px; margin-bottom:10px">
            <input type="text" id="reg-user" placeholder="@usuario" style="width:100%; padding:10px; margin-bottom:10px">
            <button class="btn-round" style="width:100%" onclick="registrar()">Criar Conta</button>
        </div>
    </div>

    <div id="home-container">
        <div class="header-app">
            <h2>Vivido</h2>
            <button onclick="sair()" style="border:none; background:none; color:#ff4444">Sair</button>
        </div>
        <div class="search-bar">
            <input type="text" id="search-user" placeholder="Buscar @usuario...">
            <button class="btn-round" onclick="buscarAmigo()">üîç</button>
        </div>
        <div id="contatos-recentes" style="padding:20px; color:#666; text-align:center">
            Busque um amigo para conversar!
        </div>
    </div>

    <div id="chat-container">
        <div class="header-app">
            <button onclick="voltar()" style="border:none; background:none; font-size:1.2rem">‚¨Ö</button>
            <div style="text-align:center">
                <b id="chat-nome">Amigo</b><br>
                <small id="typing-status" style="color:var(--accent); font-weight:bold"></small>
            </div>
            <div style="width:30px"></div>
        </div>
        <div id="messages"></div>
        <div id="footer">
            <div class="input-area">
                <label for="chat-file" style="cursor:pointer">üìé</label>
                <input type="file" id="chat-file" accept="image/*" style="display:none" onchange="enviarMidia(event, 'imagem')">
                <input id="input-msg" placeholder="Mensagem...">
                <span id="mic-icon" style="cursor:pointer" onclick="gravarAudio()">üé§</span>
                <button class="btn-round" onclick="enviarTexto()" style="width:40px; height:40px; border-radius:50%">‚û§</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let meuUser = null;
        let amigoAtual = "";
        let fotoBase64 = "https://api.dicebear.com/7.x/avataaars/svg?seed=1";

        window.onload = () => {
            const salvo = localStorage.getItem('vivido_v3');
            if (salvo) {
                meuUser = JSON.parse(salvo);
                socket.emit('entrar', meuUser);
                irParaHome();
            } else {
                document.getElementById('login-container').style.display = 'flex';
            }
        };

        async function registrar() {
            const dados = { 
                nome: document.getElementById('reg-nome').value, 
                username: document.getElementById('reg-user').value, 
                avatar: fotoBase64 
            };
            const res = await fetch('/registrar', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados)});
            if(res.ok) {
                localStorage.setItem('vivido_v3', JSON.stringify(dados));
                location.reload();
            }
        }

        function previewImg(e) {
            const reader = new FileReader();
            reader.onload = () => { fotoBase64 = reader.result; document.getElementById('reg-preview').src = reader.result; };
            reader.readAsDataURL(e.target.files[0]);
        }

        async function buscarAmigo() {
            const user = document.getElementById('search-user').value;
            const res = await fetch(`/buscar/${user}`);
            if(res.ok) {
                const amigo = await res.json();
                abrirChat(amigo.username, amigo.nome);
            } else { alert("Usu√°rio n√£o encontrado!"); }
        }

        function abrirChat(username, nome) {
            amigoAtual = username;
            document.getElementById('chat-nome').innerText = nome;
            document.getElementById('home-container').style.display = 'none';
            document.getElementById('chat-container').style.display = 'flex';
            document.getElementById('messages').innerHTML = '';
            socket.emit('carregar-conversa', username);
        }

        function enviarTexto() {
            const txt = document.getElementById('input-msg').value;
            if(!txt) return;
            socket.emit('private message', { para: amigoAtual, texto: txt });
            document.getElementById('input-msg').value = '';
        }

        function enviarMidia(e, tipo) {
            const reader = new FileReader();
            reader.onload = () => socket.emit('private message', { para: amigoAtual, imagem: reader.result });
            reader.readAsDataURL(e.target.files[0]);
        }

        function renderMsg(m) {
            const eMinha = m.de === meuUser.username;
            const wrap = document.createElement('div');
            wrap.className = `msg-wrapper ${eMinha ? 'minha-msg' : 'outra-msg'}`;
            
            let conteudo = m.texto ? `<div>${m.texto}</div>` : '';
            if(m.imagem) conteudo += `<img src="${m.imagem}">`;
            if(m.audio) conteudo += `<audio controls src="${m.audio}"></audio>`;

            wrap.innerHTML = `<div class="msg-box">${conteudo}<span class="msg-time">${m.hora}</span></div>`;
            document.getElementById('messages').appendChild(wrap);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        // Socket Events
        socket.on('new message', (m) => { if(m.de === amigoAtual || m.de === meuUser.username) renderMsg(m); });
        socket.on('historico-privado', (lista) => lista.forEach(renderMsg));
        socket.on('user-typing', (d) => { if(d.from === amigoAtual) document.getElementById('typing-status').innerText = d.typing ? "digitando..." : ""; });

        // Utils
        function irParaHome() { document.getElementById('home-container').style.display = 'flex'; }
        function voltar() { document.getElementById('chat-container').style.display = 'none'; irParaHome(); }
        function sair() { localStorage.removeItem('vivido_v3'); location.reload(); }
        
        // Digitando
        document.getElementById('input-msg').oninput = () => {
            socket.emit('typing', { para: amigoAtual, typing: true });
            clearTimeout(window.t);
            window.t = setTimeout(() => socket.emit('typing', { para: amigoAtual, typing: false }), 2000);
        };
    </script>
</body>
</html>