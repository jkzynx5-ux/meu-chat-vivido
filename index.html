<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Vivido Pro</title>
    <style>
        :root {
            --gradient-me: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%);
            --gradient-bg: linear-gradient(180deg, #a1c4fd 0%, #c2e9fb 100%);
            --glass-bg: rgba(255, 255, 255, 0.9);
            --accent: #00a884;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--gradient-bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .chat-header { background: white; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 10px rgba(0,0,0,0.05); z-index: 10; }
        .header-info { display: flex; align-items: center; gap: 12px; }
        #room-selector { border: 1px solid #eee; padding: 5px; border-radius: 8px; font-size: 0.8rem; background: #f8f9fa; outline: none; }
        #typing-monitor { font-size: 0.7rem; color: var(--accent); font-weight: bold; height: 12px; }

        /* MENSAGENS */
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg-wrapper { display: flex; align-items: flex-start; gap: 8px; max-width: 85%; }
        .msg-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-top: 5px; }
        
        .minha-msg { align-self: flex-end; flex-direction: row-reverse; }
        .minha-msg .msg-content { background: var(--gradient-me); color: white; border-radius: 18px 18px 0 18px; padding: 10px 15px; }
        .minha-msg .msg-avatar { display: none; }

        .outra-msg { align-self: flex-start; }
        .outra-msg .msg-content { background: var(--glass-bg); color: #333; border-radius: 18px 18px 18px 0; padding: 10px 15px; }

        .msg-content img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }
        audio { max-width: 200px; margin-top: 5px; }
        .msg-time { font-size: 0.6rem; margin-top: 4px; display: block; text-align: right; opacity: 0.7; }

        /* FOOTER */
        #footer { padding: 15px 20px; }
        #form { background: #333; border-radius: 30px; padding: 6px 15px; display: flex; align-items: center; gap: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        #input { flex: 1; background: transparent; border: none; color: white; outline: none; padding: 10px 0; }
        .icon-btn { color: #bbb; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
        .icon-btn:hover { color: white; }
        .send-btn { background: var(--accent); border: none; width: 38px; height: 38px; border-radius: 50%; color: white; cursor: pointer; }
        .recording { color: #ff4444 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* LOGIN (Oculto no come√ßo) */
        #login-container { position: fixed; inset: 0; background: #fff; display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .login-box { width: 100%; max-width: 350px; text-align: center; }
        .login-box input { width: 100%; padding: 14px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #ddd; outline: none; }
        .login-box button { width: 100%; padding: 14px; border-radius: 12px; background: #333; color: white; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <audio id="som-notificacao" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

    <div id="login-container">
        <div class="login-box">
            <h2 style="margin-bottom: 20px;">Configurar Perfil</h2>
            <div style="position: relative; width: 100px; height: 100px; margin: 0 auto 20px;">
                <img id="preview-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=custom" style="width:100%; height:100%; border-radius:50%; border:3px solid var(--accent); object-fit: cover;">
                <label for="reg-photo" style="position:absolute; bottom:0; right:0; background:var(--accent); width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:white; border:2px solid white;">üì∑</label>
                <input type="file" id="reg-photo" accept="image/*" style="display:none" onchange="processarFoto(event, 'perfil')">
            </div>
            <input type="text" id="nome" placeholder="Seu Nome">
            <input type="text" id="user" placeholder="Nome de usu√°rio">
            <input type="password" id="pass" placeholder="Senha">
            <button onclick="registrar()">Entrar</button>
        </div>
    </div>

    <div class="chat-header" id="header" style="display:none;">
        <div class="header-info">
            <div style="font-weight: bold; color: #333;">‚ö° Vivido Pro</div>
            <div>
                <select id="room-selector" onchange="mudarSala()">
                    <option value="Geral">üåç Geral</option>
                    <option value="Games">üéÆ Games</option>
                </select>
                <p id="typing-monitor"></p>
            </div>
        </div>
        <button onclick="sair()" style="background:none; border:none; color:#999; cursor:pointer;">Sair</button>
    </div>

    <div id="messages"></div>

    <div id="footer" style="display:none;">
        <form id="form">
            <label for="chat-photo" class="icon-btn">üìé</label>
            <input type="file" id="chat-photo" accept="image/*" style="display:none" onchange="processarFoto(event, 'chat')">
            
            <input id="input" autocomplete="off" placeholder="Digite uma mensagem..." />
            
            <span id="mic-btn" class="icon-btn" onclick="toggleAudio()">üé§</span>
            <button type="submit" class="send-btn">‚û§</button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let meuUser = null;
        let fotoPerfil = "https://api.dicebear.com/7.x/avataaars/svg?seed=custom";
        
        // Audio Recording Vars
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        window.onload = () => {
            const salvo = localStorage.getItem('vivido_login');
            if (salvo) {
                meuUser = JSON.parse(salvo);
                document.getElementById('header').style.display = 'flex';
                document.getElementById('footer').style.display = 'block';
                mudarSala(); 
            } else {
                document.getElementById('login-container').style.display = 'flex';
            }
        };

        function processarFoto(event, tipo) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function() {
                const img = new Image();
                img.src = reader.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const max = 400; 
                    const scale = max / Math.max(img.width, img.height);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    const base64 = canvas.toDataURL('image/jpeg', 0.7);
                    
                    if(tipo === 'perfil') {
                        fotoPerfil = base64;
                        document.getElementById('preview-avatar').src = base64;
                    } else {
                        socket.emit('chat message', { imagem: base64 });
                    }
                }
            }
            if(file) reader.readAsDataURL(file);
        }

        async function toggleAudio() {
            const btn = document.getElementById('mic-btn');
            if (!isRecording) {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => socket.emit('chat message', { audio: reader.result });
                };
                mediaRecorder.start();
                isRecording = true;
                btn.classList.add('recording');
            } else {
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('recording');
            }
        }

        function renderMsg(data) {
            const eMinha = data.usuarioLogado === meuUser.username;
            const item = document.createElement('div');
            item.className = `msg-wrapper ${eMinha ? 'minha-msg' : 'outra-msg'}`;
            
            let conteudo = '';
            if(data.texto) conteudo = `<div>${data.texto}</div>`;
            if(data.imagem) conteudo = `<img src="${data.imagem}">`;
            if(data.audio) conteudo = `<audio controls src="${data.audio}"></audio>`;

            item.innerHTML = `
                <img class="msg-avatar" src="${data.avatar}">
                <div class="msg-content">
                    ${!eMinha ? `<span class="msg-info">${data.exibirNome}</span>` : ''}
                    ${conteudo}
                    <span class="msg-time">${data.hora}</span>
                </div>
            `;
            document.getElementById('messages').appendChild(item);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        // Fun√ß√µes B√°sicas
        async function registrar() {
            const user = { nome: document.getElementById('nome').value, username: document.getElementById('user').value, pass: document.getElementById('pass').value, avatar: fotoPerfil };
            const res = await fetch('/registrar', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(user) });
            if (res.ok) { localStorage.setItem('vivido_login', JSON.stringify(user)); location.reload(); }
        }
        function mudarSala() { socket.emit('join-room', { sala: document.getElementById('room-selector').value, user: meuUser }); document.getElementById('messages').innerHTML = ''; }
        function sair() { localStorage.removeItem('vivido_login'); location.reload(); }
        document.getElementById('form').onsubmit = (e) => { e.preventDefault(); const val = document.getElementById('input').value; if(val) { socket.emit('chat message', { texto: val }); document.getElementById('input').value = ''; } };
        socket.on('chat message', data => renderMsg(data));
        socket.on('historico', lista => lista.forEach(m => renderMsg(m)));
    </script>
</body>
</html>